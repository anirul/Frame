name: C++ CI with vcpkg and gtest

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        lfs: true
        submodules: true

    - name: Git-lfs pull
      run: |
        git lfs pull
        
    #- name: Install Vulkan SDK
    #  run: |
    #    Invoke-WebRequest -Uri "https://sdk.lunarg.com/sdk/download/1.3.261.1/windows/VulkanSDK-1.3.261.1-Installer.exe" -OutFile "VulkanSDKInstaller.exe"
    #    Start-Process ./VulkanSDKInstaller.exe -ArgumentList "/S" -NoNewWindow -Wait
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build libxmu-dev libxi-dev libgl-dev libglx-dev libgles-dev build-essential libx11-xcb-dev libegl1-mesa-dev libopengl-dev libxkbcommon-dev libwayland-dev libxrandr-dev mesa-vulkan-drivers libglu1-mesa-dev libdrm-dev libegl-dev libglm-dev

    - name: Bootstrap vcpkg
      run: |
        cd external/vcpkg
        ./bootstrap-vcpkg.sh
        ./vcpkg integrate install

    # No need for a manual vcpkg install step, the manifest mode will handle it

    - name: Configure with CMake Preset
      run: cmake --preset linux-release

    - name: Build with CMake Preset
      run: cmake --build --preset linux-release
        
    - name: Run tests using CTest
      run: |
        cd build/linux-release
        xvfb-run ctest --output-on-failure
